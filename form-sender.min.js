/*!
 * Form sender v4.0.0
 *
 * Copyright (c) 2015 Roman Proshin
 */
var FormSender=function(e){function n(){$("[data-type]").unbind().click(function(e){e.preventDefault();var n=$(this),a=n.data("type"),i=n.data("yagoal"),o=n.data("modal"),r=[];n.data("optional-names")&&r.push(n.data("optional-names"));var u=o?$("#"+o):l.fmRequest;$(u).find("input").val(""),$(u).find(".ignore").removeClass("ignore"),t(u,"type"),t(u,"yagoal"),$(u).find("input[name=type]").val(a),$(u).find("input[name=yagoal]").val(i);for(var s in r)r.hasOwnProperty(s)&&$(u).find("input[name="+r[s]+"]").addClass("ignore");return l.onOpenDialog(u,n),$(u).modal(),!1})}function t(e,n){0===$(e).find("form input[name="+n+"]").length&&$(e).find("form").append($("<input/>",{type:"hidden",name:n}))}function a(){$("form").each(function(){$(this).find("[type=file]").change(function(){this.files&&this.files[0]&&this.files[0].size>26214400&&(alert("Превышен размер файла! Максимальный допустимый размер - 25 мегабайт."),$(this).val(null))}),$(this).validate({submitHandler:function(e){var n=$(e);try{var t=new FormData($(e)[0]),a="";n.find("input[name=phone]").length>1?n.find("input[name=phone]").each(function(){a+=$(this).val()}):a=n.find("input[name=phone]").val();var i={name:n.find("input[name=name]").val(),email:n.find("input[name=email]").val(),phone:a,type:n.find("input[name=type]").val(),referrer:l.referrer,query:location.search,fields:new o(location).getLabels()};t.append("request",$.toJSON(i)),$.ajax({url:l.url,data:t,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(){$(l.fmRequest).modal("hide"),l.onSendRequest&&l.onSendRequest(),n.find("input[type=text]").val("")},statusCode:{413:function(){alert("Превышен максимальный размер файла в 25 мегабайт!")},415:function(){alert("Неправильный формат файла! Разрешена отправка только изображений.")}}})}catch(r){return console.log(r),!1}finally{try{var u=n.find("[name=yagoal]").val();l.getYaCounter&&u&&l.getYaCounter().reachGoal&&l.getYaCounter().reachGoal(u)}catch(r){window.console&&window.console.error("Can not send a Yandex Goal",r)}}return!1},ignore:".ignore",errorPlacement:function(e,n){$(n).attr("title",$(e).text())},rules:{phone:"required",email:"email"},messages:{phone:{required:"Пожалуйста, укажите Ваш телефонный номер"},email:{email:"Пожалуйста, укажите корректный адрес электронной почты"}}})})}function i(){function e(e){var n;n=e.length?e:$(l.modalClassToCenter+":visible"),n.each(function(e){var n=$(this).clone().css("display","block").appendTo("body"),t=Math.round((n.height()-n.find(".modal-content").height())/2);t=t>0?t:0,n.remove(),$(this).find(".modal-content").css("margin-top",t)})}$(l.modalClassToCenter).on("show.bs.modal",function(n){e($(this))}),$(window).on("resize",e)}function o(e){function n(e){return t[e]?t[e]+" ("+e+")":e}this.getLabels=function(){var t=[];"string"!=typeof e&&(e=""+e),e.indexOf("?")>-1&&(e=e.slice(e.indexOf("?")+1));var a=e.split("&");for(var i in a)if(a.hasOwnProperty(i)){var o=a[i],r=n(o.split("=")[0]);t.push({name:r,value:decodeURIComponent(o.split("=")[1])})}return t};var t={utm_source:"Источник перехода",utm_campaign:"Рекламная кампания",utm_medium:"Тип трафика",utm_term:"Ключевая фраза",utm_content:"Доп. информация"}}var r={url:"http://"+location.host+"/app/api/requests/new",referrer:location.hostname,getYaCounter:null,fmRequest:$("#fmRequest"),modalClassToCenter:".modal",onSendRequest:function(){},onOpenDialog:function(e,n){},getSearchQuery:function(){return location.search}},l=$.extend({},r,e);this.rebindButtons=function(){n()},n(),a(),i()};